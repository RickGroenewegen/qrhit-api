<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Offerte - <%= company.name %></title>
    <style>
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: #333;
            background: white;
            font-size: 14px;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            padding: 12mm 15mm;
            box-sizing: border-box;
            background: white;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }

        .quotation-title {
            font-size: 42px;
            color: #5FBFFF;
            font-weight: 300;
            letter-spacing: -1px;
        }

        .company-section {
            text-align: right;
        }

        .company-section .label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .logo {
            height: 50px;
            width: auto;
            margin-bottom: 8px;
        }

        .company-details {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
            text-align: right;
        }

        /* Contact and Details Section */
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-bottom: 15px;
        }

        .info-box {
            position: relative;
        }

        .info-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            padding-left: 15px;
            position: relative;
        }

        .info-label:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 15px;
            background: #5FBFFF;
        }

        .info-content {
            padding-left: 15px;
        }

        .info-content .name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .info-content .details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .info-field {
            margin-top: 4px;
            display: flex;
            gap: 12px;
        }

        .info-field .field-label {
            font-weight: 600;
            color: #333;
            min-width: 60px;
            display: inline-block;
        }

        /* Quotation Details Box */
        .quotation-details {
            background: #f9f9f9;
            padding: 12px 15px;
            border-radius: 4px;
        }

        .quotation-details .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .quotation-details .detail-label {
            color: #666;
        }

        .quotation-details .detail-value {
            color: #333;
            font-weight: 600;
        }

        /* Table Section */
        .table-container {
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead {
            background: #5FBFFF;
            color: white;
        }

        thead th {
            padding: 8px 15px;
            text-align: left;
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
        }

        thead th:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }

        thead th:nth-child(2),
        thead th:nth-child(3),
        thead th:nth-child(4) {
            text-align: right;
        }

        thead th:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody td {
            padding: 8px 15px;
            font-size: 13px;
            color: #333;
        }

        tbody td:nth-child(2) {
            text-align: right;
        }

        tbody td:nth-child(3),
        tbody td:nth-child(4) {
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
        }

        .item-description {
            color: #333;
        }

        .item-details {
            display: block;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        /* Totals Section */
        .totals-container {
            margin-top: -1px;
            margin-bottom: 15px;
        }

        .totals-table {
            width: 100%;
            margin-top: -1px;
        }

        .totals-table td {
            padding: 4px 15px;
            font-size: 13px;
        }

        .totals-table td:last-child {
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
            width: 17.5%;
        }

        .totals-table td:first-child {
            text-align: right;
            padding-right: 20px;
            color: #666;
        }

        .total-row.subtotal td {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            font-size: 13px;
        }

        .total-row.grand-total td {
            padding-top: 10px;
            border-top: 2px solid #5FBFFF;
            font-weight: 600;
            font-size: 13px;
        }

        .total-row.vat td {
            color: #666;
            font-style: italic;
            font-size: 13px;
        }

        .total-row.vat td:last-child {
            font-weight: 600;
            font-style: normal;
            text-align: right;
        }

        .total-row.grand-total-incl td {
            padding-top: 8px;
            border-top: 2px solid #5FBFFF;
            font-size: 16px;
            font-weight: bold;
        }

        .total-row.grand-total-incl td:last-child {
            color: #5FBFFF;
            font-size: 18px;
        }

        /* Terms Section */
        .terms-section {
            margin-bottom: 25px;
            page-break-before: always;
            padding-top: 15mm; /* Match container padding for proper page 2 top margin */
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #5FBFFF;
            display: inline-block;
        }

        .terms-list {
            list-style: none;
            padding: 0;
        }

        .terms-list li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .terms-list li:before {
            content: counter(item) ".";
            counter-increment: item;
            position: absolute;
            left: 0;
            color: #5FBFFF;
            font-weight: 600;
        }

        .terms-list {
            counter-reset: item;
        }

        /* Notes Section */
        .notes-section {
            margin-bottom: 40px;
            page-break-before: always;
            padding-top: 15mm;
        }

        .notes-content {
            font-size: 13px;
            color: #666;
            line-height: 1.8;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #5FBFFF;
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .footer-content {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .footer-content strong {
            color: #333;
        }

        .footer-content a {
            color: #5FBFFF;
            text-decoration: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 class="quotation-title">Offerte</h1>
            </div>
            <div class="company-section">
                <div class="label">Offerte door</div>
                <img src="<%= baseUrl %>/assets/images/logo.png" alt="QRSong!" class="logo" />
                <div class="company-details">
                    QRSong!<br>
                    Box A3821<br>
                    Keurenplein 41<br>
                    1069CD Amsterdam<br>
                    zakelijk@qrsong.io<br>
                    KVK: 99311917<br>
                    BTW: 8689.27.764.B.01
                </div>
            </div>
        </div>

        <!-- Contact Info and Quote Details -->
        <div class="info-section">
            <div class="info-box">
                <div class="info-label">Offerte gericht aan</div>
                <div class="info-content">
                    <div class="name"><%= company.name %></div>
                    <div class="details">
                        <% if (company.address && company.housenumber) { %>
                            <%= company.address %> <%= company.housenumber %><br>
                        <% } %>
                        <% if (company.zipcode && company.city) { %>
                            <%= company.zipcode %> <%= company.city %><br>
                        <% } %>
                        <% if (company.countrycode) { %>
                            <%= company.countrycode %><br>
                        <% } %>

                        <% if (company.contact) { %>
                            <div class="info-field">
                                <span class="field-label">Contact</span>
                                <span><%= company.contact %></span>
                            </div>
                        <% } %>
                        <% if (company.contactphone) { %>
                            <div class="info-field">
                                <span class="field-label">Tel</span>
                                <span><%= company.contactphone %></span>
                            </div>
                        <% } %>
                        <% if (company.contactemail) { %>
                            <div class="info-field">
                                <span class="field-label">Email</span>
                                <span><%= company.contactemail %></span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <div class="info-label">Offerte Details</div>
                <div class="quotation-details">
                    <div class="detail-row">
                        <span class="detail-label">Offerte #</span>
                        <span class="detail-value"><%= quotationNumber %></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Offerte Datum</span>
                        <span class="detail-value"><%= formatDate(new Date()) %></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Geldig tot</span>
                        <span class="detail-value"><%= formatDate(validUntil) %></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%">Omschrijving</th>
                        <th style="width: 15%">Aantal</th>
                        <th style="width: 17.5%">Prijs excl. BTW</th>
                        <th style="width: 17.5%">Bedrag excl. BTW</th>
                    </tr>
                </thead>
                <tbody>
                    <%
                        // Determine the price per unit to use
                        const pricePerUnit = calculatedPrices && calculatedPrices.clientPricePerUnit
                            ? calculatedPrices.clientPricePerUnit
                            : calculationResult.pricePerSet;
                        const quantity = calculationResult.quantity;
                        const lineTotal = pricePerUnit * quantity;
                    %>
                    <!-- Main product line -->
                    <tr>
                        <td>
                            <span class="item-description"><%= productDescription || 'QRSong! muziekkaarten set' %></span>
                            <span class="item-details">
                                <%= productDetails || 'Een doos met 2 kleinere doosjes met ieder 48 kaarten' %>
                            </span>
                        </td>
                        <td><%= quantity %></td>
                        <td>€&nbsp;<%= formatEuro(pricePerUnit) %></td>
                        <td>€&nbsp;<%= formatEuro(lineTotal) %></td>
                    </tr>

                    <!-- Extras (filter out custom app as it's shown separately) -->
                    <% if (calculationResult.extras && calculationResult.extras.length > 0) { %>
                        <% calculationResult.extras.filter(extra => !extra.name.toLowerCase().includes('app')).forEach(function(extra) { %>
                        <tr>
                            <td>
                                <span class="item-description"><%= extra.name %></span>
                                <span class="item-details">Eenmalige kosten</span>
                            </td>
                            <td>1</td>
                            <td>€&nbsp;<%= formatEuro(extra.price) %></td>
                            <td>€&nbsp;<%= formatEuro(extra.price) %></td>
                        </tr>
                        <% }); %>
                    <% } %>
                    <% if (calculationResult.customAppFee > 0) { %>
                    <tr>
                        <td>
                            <span class="item-description">App in eigen stijl</span>
                            <span class="item-details">Eenmalige kosten - maatwerk app ontwikkeling</span>
                        </td>
                        <td>1</td>
                        <td>€&nbsp;350,00</td>
                        <td>€&nbsp;350,00</td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Totals -->
        <%
            // Calculate subtotal from line items - use calculatedPrices when available
            const mainProductTotal = calculatedPrices && calculatedPrices.clientPricePerUnit
                ? calculatedPrices.clientPricePerUnit * calculationResult.quantity
                : calculationResult.pricePerSet * calculationResult.quantity;
            // Filter out app from extras to avoid double counting (custom app is shown separately)
            const extrasTotal = calculationResult.extras && calculationResult.extras.length > 0
                ? calculationResult.extras.filter(extra => !extra.name.toLowerCase().includes('app')).reduce((sum, extra) => sum + extra.price, 0)
                : 0;
            const customAppFeeTotal = calculationResult.customAppFee || 0;
            const subtotal = mainProductTotal + extrasTotal + customAppFeeTotal;

            // Apply manual discount percentage
            const manualDiscountPct = calculation.manualDiscountPercent || 0;
            const discountAmount = subtotal * (manualDiscountPct / 100);
            const totalAfterDiscount = subtotal - discountAmount;

            const vat = Math.round(totalAfterDiscount * 0.21 * 100) / 100; // Round VAT to 2 decimals
            const totalInclVat = totalAfterDiscount + vat; // Add rounded VAT to subtotal
        %>
        <div class="totals-container">
            <table class="totals-table">
                <tr class="total-row subtotal">
                    <td colspan="3">Subtotaal</td>
                    <td>€&nbsp;<%= formatEuro(subtotal) %></td>
                </tr>

                <% if (manualDiscountPct > 0) { %>
                <tr class="total-row discount">
                    <td colspan="3">Korting (<%= manualDiscountPct %>%)</td>
                    <td>-€&nbsp;<%= formatEuro(discountAmount) %></td>
                </tr>
                <% } %>

                <tr class="total-row grand-total">
                    <td colspan="3">Totaal excl. BTW</td>
                    <td>€&nbsp;<%= formatEuro(totalAfterDiscount) %></td>
                </tr>

                <tr class="total-row vat">
                    <td colspan="3">BTW 21%</td>
                    <td>€&nbsp;<%= formatEuro(vat) %></td>
                </tr>

                <tr class="total-row grand-total-incl">
                    <td colspan="3">Totaal incl. BTW</td>
                    <td>€&nbsp;<%= formatEuro(totalInclVat) %></td>
                </tr>
            </table>
        </div>

        <!-- Signature Section -->
        <div style="margin-top: 12px;">
            <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; width: 50%;">
                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Voor akkoord namens <%= company.name %></div>
                <div style="border-bottom: 1px solid #ccc; height: 30px;"></div>
            </div>
        </div>

        <!-- Deposit Notice -->
        <div class="deposit-notice" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 4px solid #5FBFFF; border-radius: 4px;">
            <strong style="color: #5FBFFF; font-size: 12px;">Aanbetaling</strong>
            <p style="margin: 4px 0 0 0; font-size: 11px; color: #666; line-height: 1.3;">
                Bij akkoord op deze offerte wordt een aanbetaling van 30% van het totaalbedrag gefactureerd. Na ontvangst van de aanbetaling wordt de order in behandeling genomen en de productie/uitvoering ingepland.
            </p>
        </div>

        <!-- Notes Section (Page 2) -->
        <div class="notes-section">
            <h2 class="section-title">Productinformatie</h2>
            <div class="notes-content">
                <% if (productType === 'schneider') { %>
                    <%
                        const cardCount = calculation.cardCount || 48;
                        const totalCards = calculationResult.quantity * cardCount;
                    %>
                    <strong>Wat wordt geleverd:</strong><br>
                    • <%= calculationResult.quantity %> QRSong! Box<%= calculationResult.quantity > 1 ? 'en' : '' %><br>
                    • Elke doos bevat <%= cardCount %> muziekkaarten<br>
                    • Totaal: <%= calculationResult.quantity %> dozen en <%= totalCards %> kaarten<br><br>

                    <strong>Specificaties Doos:</strong><br>
                    <% if (cardCount === 48) { %>
                    • Gelamineerde doos met zijklepje<br>
                    • Volledig bedrukbaar in eigen stijl<br>
                    <% } else if (cardCount === 96) { %>
                    • 2x48 kaarten in banderol, 2-vaks doos met los dekseltje<br>
                    • Stevig SK2 karton, binnen & buiten bedrukbaar<br>
                    <% } else if (cardCount === 144) { %>
                    • 2x72 kaarten in banderol, 2-vaks doos met los dekseltje<br>
                    • Stevig SK2 karton, binnen & buiten bedrukbaar<br>
                    <% } else { %>
                    • 4x48 kaarten in banderol, 4-vaks doos met los dekseltje<br>
                    • Stevig SK2 karton, binnen & buiten bedrukbaar<br>
                    <% } %>
                    <br>

                    <strong>Specificaties Kaarten:</strong><br>
                    • Formaat: 56 x 56 mm, afgeronde hoeken<br>
                    • Materiaal: 350 grams karton met glanslaminaat<br>
                    • Bedrukking: tweezijdig full colour<br>
                    • QR-code gelinkt aan muziek
                <% } else { %>
                    <strong>Wat wordt geleverd:</strong><br>
                    • <%= calculationResult.quantity %> complete sets<br>
                    • Elke set bevat: Een doos, met 2 kleinere doosjes die ieder 48 kaarten bevatten (Totaal 96 kaarten)<br>
                    • Totaal: <%= calculationResult.quantity %> dozen en <%= calculationResult.quantity * 96 %> kaarten<br><br>

                    <strong>Specificaties Doosjes:</strong><br>
                    • Materiaal: incada excel (gc2), wit, 325 grs/m²<br>
                    • Bedrukking: 5/0 Voorzijde full-colour + all over glanzend dispersielak<br>
                    • Formaat: 17,5 x 19,1 cm<br>
                    • Afwerking: stansen, rillen en uitbreken, kaartspeldoosjes langsnaadplakken<br>
                    • Twee kaartdoosjes (fefco0210): plano 175x191mm, inhoudmaat 62x16x122mm<br>
                    • Verzameldoosje (fefco0427): plano 227x338mm, inhoudsmaat 123x123x18mm<br><br>

                    <strong>Specificaties Kaarten:</strong><br>
                    • Materiaal: tweezijdig gesteken sulfaatkarton, wit, 300 grs/m²<br>
                    • Bedrukking: 4/4 tweezijdig full colour in digidruk<br>
                    • Formaat: 6 x 6 cm<br>
                    • Afwerking: per 2x48 stuks verpakt in doosjes
                <% } %>
            </div>
        </div>

        <!-- Terms and Conditions (Page 3) -->
        <div class="terms-section">
            <h2 class="section-title">Algemene Voorwaarden</h2>
            <ol class="terms-list">
                <li>Aanbetaling: Bij akkoord op deze offerte wordt een aanbetaling van 30% van het totaalbedrag gefactureerd. Na ontvangst van de aanbetaling wordt de order in behandeling genomen en de productie/uitvoering ingepland.</li>
                <li>Betaling dient te geschieden binnen 14 dagen na factuurdatum.</li>
                <li>Alle bedragen zijn in EUR, betaling via bankoverschrijving.</li>
                <li>Bij akkoord graag deze offerte ondertekend retour.</li>
                <li>Deze offerte is geldig tot <%= formatDate(validUntil) %>.</li>
                <li>Indicatieve levertijd: Opgegeven levertijden zijn indicatief en gelden niet als fatale termijnen, tenzij uitdrukkelijk schriftelijk anders is overeengekomen.</li>
                <li>Startmoment levertijd: Levertijden gaan in nadat de overeenkomst tot stand is gekomen én alle voor uitvoering noodzakelijke informatie, bestanden, goedkeuringen (zoals een drukproef) en eventuele (aan)betalingen door Opdrachtnemer zijn ontvangen.</li>
                <li>Vertraging en ingebrekestelling: Bij overschrijding van een levertijd informeert Opdrachtnemer Opdrachtgever zo spoedig mogelijk. Opdrachtgever kan de overeenkomst pas ontbinden nadat Opdrachtnemer schriftelijk in gebreke is gesteld en een redelijke termijn voor nakoming is geboden, en nakoming binnen die termijn uitblijft.</li>
                <li>Aansprakelijkheid bij vertraging: Opdrachtnemer is niet aansprakelijk voor schade als gevolg van overschrijding van levertijden, behoudens opzet of bewuste roekeloosheid. Eventuele aansprakelijkheid is in ieder geval beperkt tot het factuurbedrag van het betreffende deel van de opdracht.</li>
                <li>Overmacht: In geval van overmacht wordt de levertijd opgeschort voor de duur van de overmachtssituatie. Onder overmacht wordt mede verstaan: niet-tijdige levering door toeleveranciers, transportproblemen, storingen, ziekte, brand, overheidsmaatregelen en andere omstandigheden buiten de invloedssfeer van Opdrachtnemer.</li>
                <li>De QR-codes linken naar Spotify. Wij streven ernaar links werkend te houden en kunnen deze updaten indien nodig. Echter, als Spotify een nummer volledig verwijdert, is dit buiten onze controle.</li>
                <li>De app werkt ook zonder Spotify Premium, maar dan ziet de gebruiker na een korte countdown de artiest/titel en speelt een 30-seconden preview. Met Premium blijft alles verborgen tot je raadt.</li>
                <li>Afhankelijkheid van Derden: QRSong! streeft naar continue beschikbaarheid van de digitale diensten. De werking van het product is echter afhankelijk van externe dienstverleners, waaronder maar niet beperkt tot muziekstreamingdiensten (Spotify, Apple Music, YouTube Music, Deezer, Tidal), hosting- en infrastructuurproviders. QRSong! kan niet aansprakelijk worden gesteld voor storingen, wijzigingen in functionaliteit, of beëindiging van diensten door deze derden. Bij substantiële wijzigingen zal QRSong! zich inspannen om een passend alternatief te bieden, zonder dat hieraan rechten kunnen worden ontleend.</li>
                <li>Beperking van Aansprakelijkheid: QRSong! is niet aansprakelijk voor indirecte of gevolgschade, fouten in de inhoud, verlies van gegevens, of schade door onjuist gebruik van de kaarten of app.</li>
            </ol>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                Voor vragen over deze offerte kunt u contact opnemen via <a href="mailto:zakelijk@qrsong.io">zakelijk@qrsong.io</a>
            </div>
        </div>
    </div>
</body>
</html>
